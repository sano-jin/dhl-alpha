<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Instruction (dhl.Generator__.Instruction)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">dhl</a> &#x00BB; <a href="../index.html">Generator__</a> &#x00BB; Instruction</nav><h1>Module <code>Generator__.Instruction</code></h1></header><aside><p>Instructions of the intermediate code</p></aside><dl><dt class="spec type" id="type-reg_i"><a href="#type-reg_i" class="anchor"></a><code><span class="keyword">type</span> reg_i</code><code> = int</code></dt><dd><p>レジスタ番号</p></dd></dl><dl><dt class="spec type" id="type-functor_"><a href="#type-functor_" class="anchor"></a><code><span class="keyword">type</span> functor_</code><code> = string * int</code></dt><dd><p>ファンクタ := (アトム名, リンクの数)</p></dd></dl><dl><dt class="spec type" id="type-lhs_inst"><a href="#type-lhs_inst" class="anchor"></a><code><span class="keyword">type</span> lhs_inst</code><code> = </code><table class="variant"><tr id="type-lhs_inst.PeakAtom" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.PeakAtom" class="anchor"></a><code>| </code><code><span class="constructor">PeakAtom</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-functor_">functor_</a></code></td><td class="doc"><p>アトムリストの先頭から随時，ファンクタが <code>functor_</code> であるアトムへの参照を，レジスタ <code>reg_i</code> に格納してゆく</p><ul><li>failable and possibly rewind</li></ul></td></tr><tr id="type-lhs_inst.CheckFunctor" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.CheckFunctor" class="anchor"></a><code>| </code><code><span class="constructor">CheckFunctor</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-functor_">functor_</a></code></td><td class="doc"><p><code>reg_i</code> に格納したアトムのファンクタが <code>functor_</code> であることを確認する</p><ul><li>failable and does not rewind</li></ul></td></tr><tr id="type-lhs_inst.CheckIndeg" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.CheckIndeg" class="anchor"></a><code>| </code><code><span class="constructor">CheckIndeg</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * int</code></td><td class="doc"><p><code>reg_i</code> に格納したアトムの参照カウンタの値が <code>int</code> であることを確認する</p><ul><li>局所リンクに必要なチェック</li><li>failable and does not rewind</li></ul></td></tr><tr id="type-lhs_inst.Deref" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.Deref" class="anchor"></a><code>| </code><code><span class="constructor">Deref</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-reg_i">reg_i</a> * int</code></td><td class="doc"><p><code>Deref dst_reg_i src_reg_i port_i</code> は レジスタ <code>src_reg_i</code> が参照するアトムの <code>port_i</code> 番目の引数をトラバースしてその先に接続されているシンボルアトムへの参照を レジスタ <code>dst_reg_i</code> に格納する</p><ul><li>not failable and does not rewind</li></ul></td></tr><tr id="type-lhs_inst.CheckRefEq" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.CheckRefEq" class="anchor"></a><code>| </code><code><span class="constructor">CheckRefEq</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-reg_i">reg_i</a></code></td><td class="doc"><p><code>CheckRefEq reg_i reg_j</code> は レジスタ <code>reg_i</code> に格納されているアドレスと レジスタ <code>reg_j</code> に格納されているアドレスが等しいことを確認する</p><ul><li>failable and does not rewind</li></ul></td></tr><tr id="type-lhs_inst.CheckRefNeq" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.CheckRefNeq" class="anchor"></a><code>| </code><code><span class="constructor">CheckRefNeq</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-reg_i">reg_i</a></code></td><td class="doc"><p><code>CheckRefEq reg_i reg_j</code> は レジスタ <code>reg_i</code> に格納されているアドレスと レジスタ <code>reg_j</code> に格納されているアドレスが異なることを確認する</p><ul><li>failable and does not rewind</li></ul></td></tr><tr id="type-lhs_inst.CheckRedirs" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.CheckRedirs" class="anchor"></a><code>| </code><code><span class="constructor">CheckRedirs</span> <span class="keyword">of</span> <span><span>(<a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-reg_i">reg_i</a>)</span> list</span> * <span><span>(<a href="index.html#type-reg_i">reg_i</a> * int)</span> list</span></code></td><td class="doc"><p>CheckRedirs redirs free_indeg_diffs</p><ul><li>引数は</li><li>リダイレクトされる自由リンクが格納されたレジスタ番号の連想リストと，</li><li>自由リンクが格納されたレジスタと，対応する自由リンクの入次数の変化分の連想リスト</li><li>自由リンクの入次数もセットする</li><li>もっと細かい命令に分けるべきな気はする</li><li>failable and does not rewind</li></ul></td></tr><tr id="type-lhs_inst.FailMatching" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.FailMatching" class="anchor"></a><code>| </code><code><span class="constructor">FailMatching</span> <span class="keyword">of</span> string</code></td><td class="doc"><p>仮想マシンを（途中で）強制終了する．デバッグのための命令</p></td></tr></table></dt><dd><p>ルール左辺におけるマッチングのための中間命令</p><ul><li>failable は失敗する可能性があるということ</li><li>rewind は後続の命令が失敗したときに巻き戻しの起点になるということ</li></ul></dd></dl><dl><dt class="spec type" id="type-lhs_insts"><a href="#type-lhs_insts" class="anchor"></a><code><span class="keyword">type</span> lhs_insts</code><code> = <span><a href="index.html#type-lhs_inst">lhs_inst</a> list</span></code></dt><dt class="spec type" id="type-rhs_inst"><a href="#type-rhs_inst" class="anchor"></a><code><span class="keyword">type</span> rhs_inst</code><code> = </code><table class="variant"><tr id="type-rhs_inst.PushAtom" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.PushAtom" class="anchor"></a><code>| </code><code><span class="constructor">PushAtom</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * int * <a href="index.html#type-functor_">functor_</a></code></td><td class="doc"><p><code>PushAtom reg_i indeg functor_</code> はルール右辺で生成する入次数 <code>indeg</code>，ファンクタ <code>functor_</code> の（シンボル）アトムを生成し，レジスタ <code>reg_i</code> に代入する</p><ul><li>アトムリストへの追加も行う</li><li>ただし，リンクの値は正しい値にセットされない</li><li>局所リンクに参照されるアトムを生成するための命令</li><li>シンボルアトムのみ対応（Indirection アトムは局所リンクに参照されないため）</li></ul></td></tr><tr id="type-rhs_inst.ReplaceAtom" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.ReplaceAtom" class="anchor"></a><code>| </code><code><span class="constructor">ReplaceAtom</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-functor_">functor_</a></code></td><td class="doc"><p><code>ReplaceAtom reg_i functor_</code> はファンクタ <code>functor_</code> の（シンボル）アトムで，レジスタ <code>reg_i</code> が参照する先のアトムを置き換える</p><ul><li>アトムリストがファンクタごとに分類されているのであれば，ファンクタが異なる場合はアトムリスト間を移動する必要がある</li><li>効率のためには異なるファンクタで置き換える場合と，同一のファンクタの場合とで異なる命令を出したほうが良いと思われる</li><li>現状はアトムリストは一本のリストなので，とりあえずこれだけでいく</li><li>ただし，リンクの値は正しい値にセットされない</li><li>入次数はマッチング末尾の CheckRedirs 命令によってすでにセット済み</li><li>自由リンクに参照されるアトムを置き換えるための命令</li><li>シンボルアトムのみ対応</li></ul></td></tr><tr id="type-rhs_inst.Redir" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.Redir" class="anchor"></a><code>| </code><code><span class="constructor">Redir</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-reg_i">reg_i</a></code></td><td class="doc"><p><code>Redir reg_i reg_j</code> はレジスタ <code>reg_i</code> が参照する先のアトムをレジスタ <code>reg_j</code> が参照する先のアトムを参照する Indirection アトムで置き換え， アトムリストから <code>reg_i</code> を参照していた要素を除去する</p><ul><li>リンクの値も正しい値にセットされる</li><li>入次数はマッチング末尾の CheckRedirs 命令によってすでにセット済み</li><li>入次数がゼロになっている場合はメモリを解放する</li><li>自由リンクに参照されるアトムを置き換えるための命令</li><li>Indirection アトムのみ対応</li><li>CheckRedirs ですでにセットしてしまうのでも良いかもしれない</li></ul></td></tr><tr id="type-rhs_inst.FreeAtom" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.FreeAtom" class="anchor"></a><code>| </code><code><span class="constructor">FreeAtom</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a></code></td><td class="doc"><p><code>FreeAtom reg_i</code> はレジスタ <code>reg_i</code> が参照する先のアトムをアトムリストから除去し，メモリを解放する</p><ul><li>ただし，リンクの値は正しい値にセットされない &lt;-- ???</li><li>入次数はマッチング末尾の CheckRedirs 命令によってすでにセット済み</li><li>自由リンクに参照されるアトムを置き換えるための命令</li><li>シンボルアトムのみ対応</li></ul></td></tr><tr id="type-rhs_inst.SetLink" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.SetLink" class="anchor"></a><code>| </code><code><span class="constructor">SetLink</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * int * <a href="index.html#type-reg_i">reg_i</a></code></td><td class="doc"><p><code>SetLink src_reg_i port_i dst_reg_i</code> はレジスタ <code>dst_reg_i</code> が参照する先の（シンボル）アトムの <code>port_i</code> 番目のリンクにレジスタ <code>src_reg_j</code> に格納されたアドレスを代入する</p><ul><li>シンボルアトムのみ対応</li></ul></td></tr><tr id="type-rhs_inst.FailPushout" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.FailPushout" class="anchor"></a><code>| </code><code><span class="constructor">FailPushout</span> <span class="keyword">of</span> string</code></td><td class="doc"><p>仮想マシンを（途中で）強制終了する．デバッグのための命令</p></td></tr></table></dt><dd><p>ルール右辺におけるマッチングのための中間命令． どれも失敗することはない．</p></dd></dl><dl><dt class="spec type" id="type-rhs_insts"><a href="#type-rhs_insts" class="anchor"></a><code><span class="keyword">type</span> rhs_insts</code><code> = <span><a href="index.html#type-rhs_inst">rhs_inst</a> list</span></code></dt></dl><aside><p>中間コードを文字列へ変換する</p><ul><li>中間命令列のファイルを生成するため</li><li>CheckRedir 命令はこのままだと構文解析が若干面倒なので，後で変更が必要</li><li>とデバッグ時の dump のため</li></ul></aside><dl><dt class="spec value" id="val-string_of_functor"><a href="#val-string_of_functor" class="anchor"></a><code><span class="keyword">val</span> string_of_functor : <span>(string * int)</span> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_check_redirs"><a href="#val-string_of_check_redirs" class="anchor"></a><code><span class="keyword">val</span> string_of_check_redirs : <span><span>(int * int)</span> list</span> <span>&#45;&gt;</span> <span><span>(int * int)</span> list</span> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_lhs_inst"><a href="#val-string_of_lhs_inst" class="anchor"></a><code><span class="keyword">val</span> string_of_lhs_inst : <a href="index.html#type-lhs_inst">lhs_inst</a> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_rhs_inst"><a href="#val-string_of_rhs_inst" class="anchor"></a><code><span class="keyword">val</span> string_of_rhs_inst : <a href="index.html#type-rhs_inst">rhs_inst</a> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_lhs_insts"><a href="#val-string_of_lhs_insts" class="anchor"></a><code><span class="keyword">val</span> string_of_lhs_insts : <span><a href="index.html#type-lhs_inst">lhs_inst</a> list</span> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_rhs_insts"><a href="#val-string_of_rhs_insts" class="anchor"></a><code><span class="keyword">val</span> string_of_rhs_insts : <span><a href="index.html#type-rhs_inst">rhs_inst</a> list</span> <span>&#45;&gt;</span> string</code></dt></dl></div></body></html>